<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>3D deneme oyunu</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; font-family: sans-serif; pointer-events: none; text-shadow: 2px 2px 4px #000; }
    </style>
</head>
<body>
    <div id="ui">
        <h1>Savaş Alanı Gelişiyor</h1>
        <p>Hız dengelendi | Kenardan düşersen otomatik başa dönersin</p>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- ÇİMEN TEXTURE ---
        function createGrassTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a3c15'; 
            ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 15000; i++) {
                ctx.fillStyle = `rgb(10, ${60 + Math.random() * 80}, 10)`;
                ctx.fillRect(Math.random() * 512, Math.random() * 512, 2, 4);
            }
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(25, 25);
            return texture;
        }

        const light = new THREE.DirectionalLight(0xffffff, 1.2);
        light.position.set(10, 20, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x606060));

        // --- ZEMİN (100x100 Birim) ---
        const mapSize = 100;
        const floorGeo = new THREE.PlaneGeometry(mapSize, mapSize);
        const floorMat = new THREE.MeshStandardMaterial({ map: createGrassTexture() });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // --- KARAKTER ---
        const playerGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.3), new THREE.MeshStandardMaterial({color: 0x0066ff}));
        body.position.y = 1.2;
        playerGroup.add(body);
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.35, 0.35), new THREE.MeshStandardMaterial({color: 0xffdbac}));
        head.position.y = 1.8;
        playerGroup.add(head);
        
        const legGeo = new THREE.BoxGeometry(0.25, 0.8, 0.25);
        const leftLeg = new THREE.Mesh(legGeo, new THREE.MeshStandardMaterial({color: 0x222222}));
        leftLeg.position.set(-0.15, 0.4, 0);
        playerGroup.add(leftLeg);
        const rightLeg = new THREE.Mesh(legGeo, new THREE.MeshStandardMaterial({color: 0x222222}));
        rightLeg.position.set(0.15, 0.4, 0);
        playerGroup.add(rightLeg);
        scene.add(playerGroup);

        // --- DEĞİŞKENLER ---
        const keys = {};
        let pitch = 0, yaw = 0;
        let walkTimer = 0;
        let velocityY = 0;
        const gravity = 0.015;

        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);
        document.addEventListener('mousemove', (e) => {
            if (e.buttons === 1) {
                yaw -= e.movementX * 0.005;
                pitch -= e.movementY * 0.005;
                pitch = Math.max(-Math.PI / 3, Math.min(Math.PI / 8, pitch));
            }
        });

        function update() {
            const speed = 0.1; // Hız düşürüldü
            let moving = false;

            playerGroup.rotation.y = yaw;

            // Zemin Kontrolü
            const halfSize = mapSize / 2;
            const isInsideMap = Math.abs(playerGroup.position.x) < halfSize && Math.abs(playerGroup.position.z) < halfSize;

            if (isInsideMap && playerGroup.position.y <= 0) {
                // Zemindeyiz
                playerGroup.position.y = 0;
                velocityY = 0;
                
                if (keys['KeyW']) { playerGroup.translateZ(-speed); moving = true; }
                if (keys['KeyS']) { playerGroup.translateZ(speed); moving = true; }
                if (keys['KeyA']) { playerGroup.translateX(-speed); moving = true; }
                if (keys['KeyD']) { playerGroup.translateX(speed); moving = true; }
            } else {
                // Boşluktayız
                velocityY -= gravity;
                playerGroup.position.y += velocityY;
            }

            // Yeniden Doğma (Respawn)
            if (playerGroup.position.y < -30) {
                playerGroup.position.set(0, 5, 0); // Havadan doğsun ki düşüşü gör
                velocityY = 0;
            }

            // Animasyon
            if (moving) {
                walkTimer += 0.12;
                leftLeg.rotation.x = Math.sin(walkTimer) * 0.5;
                rightLeg.rotation.x = Math.sin(walkTimer + Math.PI) * 0.5;
            } else {
                leftLeg.rotation.x = 0; rightLeg.rotation.x = 0;
            }

            // Kamera
            const camDist = 7;
            camera.position.set(
                playerGroup.position.x + Math.sin(yaw) * Math.cos(pitch) * camDist,
                playerGroup.position.y + 3.5 + Math.sin(pitch) * camDist,
                playerGroup.position.z + Math.cos(yaw) * Math.cos(pitch) * camDist
            );
            camera.lookAt(playerGroup.position.x, playerGroup.position.y + 1.2, playerGroup.position.z);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
